#!/bin/bash -ex

SCRIPT_DIR=$(dirname $0)

echo "${VAULT_PASSWORD}" > vault-password

ansible-vault \
    decrypt \
    --output=terraform.tfstate \
    --vault-password-file=vault-password \
    terraform.tfstate.encrypted

INVENTORY="--inventory-file=$SCRIPT_DIR/../ansible/terraform-inventory"


ansible-playbook \
    $INVENTORY \
    --private-key=~/.ssh/id_rsa \
    --user=ubuntu \
    -c paramiko \
    -e @secrets.yml \
    --vault-password-file vault-password \
    -vvv \
    site.yml

